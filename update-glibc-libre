#!/usr/bin/env nix-shell
#! nix-shell -i zsh -p zsh gnutar xz git cacert coreutils nawk nixfmt-rfc-style --pure
#
# Copyright © 2025 Barry Schwartz
#
# This program is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License, as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received copies of the GNU General Public License
# along with this program. If not, see
# <https:#www.gnu.org/licenses/>.
#

set -e
program_name="${0}"

source glibc-libre-files/command-line.zsh
source glibc-libre-files/helpers.zsh

glibc_subdir="pkgs/development/libraries/glibc"
glibc_in_local_repo="${local_repo}/${glibc_subdir}"
glibc_dir="glibc-libre/glibc"
abs_glibc_dir=`realpath ${PWD}`/"${glibc_dir}"

function obtain_the_glibc_derivation
{
    printf "Obtaining the glibc derivation.\n"
    require_the_local_repo
    mkdir -p "${abs_glibc_dir}"
    cp -R "${glibc_in_local_repo}"/* "${abs_glibc_dir}"
}

function disable_nixonian_patch
{
    awk_edit '/\.\/dont-use-system-ld-so-cache\.patch/ {
                print ("      # NOPE! Exert our freedom, instead.")
                next
              }
              {
                print
              }
             ' "${abs_glibc_dir}"/common.nix
}

function install_ldconfig_for_sure
{
    awk_edit '{
                print
              }
              /moveToOutput bin\/getent \$getent/ {
                print ("")
                print ("      # Be sure ldconfig is installed, and also install")
                print ("      # it as ldconfig-libre. Output both ldconfig and")
                print ("      # ldconfig-libre also as lone outputs. Some may")
                print ("      # find this arrangement helpful for working around")
                print ("      # problems.")
                print ("      cp elf/ldconfig elf/ldconfig-libre")
                print ("      install -d $bin/bin")
                print ("      rm -f $bin/bin/ldconfig")
                print ("      install elf/ldconfig $bin/bin")
                print ("      install elf/ldconfig-libre $bin/bin")
                print ("      install -d $ldconfig/bin")
                print ("      install elf/ldconfig $ldconfig/bin")
                print ("      install -d $ldconfig_libre/bin")
                print ("      install elf/ldconfig-libre $ldconfig_libre/bin")
              }
              /^[[:space:]]*"getent"/ {  # FIXME: This edit could use more context.
                print ("      \"ldconfig\"")
                print ("      \"ldconfig_libre\"")
              }
             ' "${abs_glibc_dir}"/common.nix
}

function edit_for_freedom
{
    printf "Editing the derivation.\n"
    disable_nixonian_patch
    install_ldconfig_for_sure
    nixfmt "${abs_glibc_dir}"/common.nix
}

function write_nix_configuration
{
    local config="${1}"
    local deriv_dir=`basename "${abs_glibc_dir}"`

    if true; then
        printf "{ pkgs, ... }:\n"
        printf "\n"
        printf "let\n"
        printf "  glibc-libre =\n"
        printf "    pkgs:\n"
        printf "    (pkgs.callPackage %s {\n" ./"${deriv_dir}"
        printf "      stdenv = pkgs.gccStdenv;\n"
        printf "    });\n"
        printf "in\n"
        printf "{\n"
        printf "  nixpkgs = {\n"
        printf "    overlays = [\n"
        printf "      ( final: prev: { libre = glibc-libre final.pkgs; } )"
        printf "    ];\n"
        printf "  };\n"
        printf "  system = {\n"
        printf "    replaceDependencies = {\n"
        printf "      replacements = [\n"
        printf "        {\n"
        printf "          oldDependency = pkgs.glibc;\n"
        printf "          newDependency = pkgs.libre;\n"
        printf "        }\n"
        printf "      ];\n"
        printf "    };"
        printf "  };\n"
        printf "}\n"
    fi > "${config}"

    nixfmt "${config}"
}

function write_example_etc_config
{
    local config="${1}"

    if true; then
        printf "{\n"
        printf "  pkgs,\n"
        printf "  ...\n"
        printf "}:\n"
        printf "\n"
        printf "let\n"
        printf "  use-nix-ld = false;\n"
        printf "in\n"
        printf "{\n"
        printf "  #\n"
        printf "  # You can install either nix-ld or glibc-libre’s ELF\n"
        printf "  # interpreter itself as the ‘standard’ ELF interpreter.\n"
        printf "  # If you do not use nix-ld, then link or place libraries\n"
        printf "  # you wish to use into a directory listed in\n"
        printf "  # /etc/ld.so.conf and be sure to run ldconfig-libre.\n"
        printf "  # Using glibc-libre directly avoids setting LD_LIBRARY_PATH.\n"
        printf "  #\n"
        printf "  programs.nix-ld = {\n"
        printf "    enable = use-nix-ld;\n"
        printf "    libraries = [ ]; # Put a list of packages here.\n"
        printf "  };\n"
        printf "  environment.ldso =\n"
        printf "    if use-nix-ld then\n"
        printf "      null\n"
        printf "    else\n"
        printf "      \"\${pkgs.libre}/lib/ld-linux-x86-64.so.2\";\n"
        printf "\n"
        printf "  system.activationScripts = {\n"
        printf "    \"update-ld.so.cache\" = ''\n"
        printf "      if ! [ -e /etc/ld.so.conf ]; then\n"
        printf "        if true; then\n"
        printf "          printf \"# Example /etc/ld.so.conf\\\\n\"\n"
        printf "          printf \"\\\\n\"\n"
        printf "          printf \"#/lib  <-- uncomment to include\\\\n\"\n"
        printf "          printf \"#/usr/lib\\\\n\"\n"
        printf "          printf \"#/usr/local/lib\\\\n\"\n"
        printf "        fi > /etc/ld.so.conf\n"
        printf "      fi\n"
        printf "      \${pkgs.libre.bin}/bin/ldconfig-libre\n"
        printf "    '';\n"
        printf "  };\n"
        printf "}\n"
    fi > "${config}"

    nixfmt "${config}"
}

printf "Updating glibc-libre...\n"

rm -R -f glibc-libre/glibc
obtain_the_glibc_derivation
edit_for_freedom

printf "Writing Nix configurations.\n"
write_nix_configuration "glibc-libre/libre-configuration.nix"
write_example_etc_config "glibc-libre/libre-etc-config.example.nix"

printf "Done.\n"

# local variables:
# mode: shell-script
# sh-shell: zsh
# coding: utf-8
# indent-tabs-mode: nil
# end:
